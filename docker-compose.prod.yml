version: '3.8'

services:
  # API服务器（生产环境）
  api:
    build: 
      context: ./api-server
      dockerfile: Dockerfile
    container_name: translator-api-prod
    environment:
      NODE_ENV: production
      PORT: 3001
      # 使用外部MySQL和Redis
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: remote
      DB_PASSWORD: zxc6545398
      DB_NAME: translator_agent
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: "n(,fkR6X]o6E"
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRES_IN: 24h
      JWT_REFRESH_EXPIRES_IN: 7d
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      MODEL_NAME: ${MODEL_NAME}
      ZPAY_API_URL: ${ZPAY_API_URL}
      ZPAY_MERCHANT_ID: ${ZPAY_MERCHANT_ID}
      ZPAY_SECRET_KEY: ${ZPAY_SECRET_KEY}
      ZPAY_WEBHOOK_SECRET: ${ZPAY_WEBHOOK_SECRET}
      ALLOWED_ORIGINS: https://translator.aihang365.com
      API_BASE_URL: https://translator-api.aihang365.com
      VIRTUAL_HOST: translator-api.aihang365.com
      VIRTUAL_PORT: 3001
      LETSENCRYPT_HOST: translator-api.aihang365.com
      LETSENCRYPT_EMAIL: zhangke_2021@126.com
    networks:
      - nginx-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Web前端（生产环境）
  web:
    build:
      context: ./web-app
      dockerfile: Dockerfile
    container_name: translator-web-prod
    environment:
      VIRTUAL_HOST: translator.aihang365.com
      VIRTUAL_PORT: 80
      LETSENCRYPT_HOST: translator.aihang365.com
      LETSENCRYPT_EMAIL: zhangke_2021@126.com
    depends_on:
      - api
    networks:
      - nginx-proxy
    restart: unless-stopped

networks:
  nginx-proxy:
    external: true